Pumpkin MCU Service
===================

Hardware service for interacting with all Pumpkin Modules.

By default this service listens on port 8150 for UDP graphql queries and mutations.

Queries are telemetry requests (data obtained from the module).
Mutations are commands (data written to the module).
Both require I2C communications to modules on the bus.

Configuration for this service is set in `/etc/kubos-config.toml`.

The configs include:

* IP address and port to serve on.

* `i2c_type`: the type of the i2c master. Either `"kubos"` or `"i2cdriver"`. For flight, this should be set to `"kubos"`, the `"i2cdriver"` option is to facilitate testing this service without re-building kubos for an SBC. (See [testing](#testing))

* `bus_path` sets the path to the bus definition json file (generated by [pumqry](https://github.com/PumpkinSpace/PuTDIG-CLI). This defines the available telemetry and commands on the bus.


* , and bus definition are set in `/etc/kubos-config.toml`. Make sure match your hardware configuration.

Examples
--------

Example query:

```
  query {
    mcuTelemetry(
      module:"sim",
      fields:["firmware_version","scpi_cmds_processed","scpi_errs_processed"]
    )
  }
```

Example mutation:

```
  mutation {
    sendCommand(module:"sim",command:"SUP:LED ON") {
      ok
    }
  }
```

Some commands to run to test from the command line (for module "sim"):

```
  echo "query {moduleList}" | nc -uw1 127.0.0.1 8150
  echo "query {fieldList(module:\"sim\")}" | nc -uw1 127.0.0.1 8150
  echo "mutation {sendCommand(module:\"sim\",command:\"SUP:LED ON\"){ok}}" | nc -uw1 127.0.0.1 8150
```

## Testing
In order to test changes to this service without re-building kubos for an OBC, you can run it from your development machine, talking to a bus over an [i2c driver board](https://i2cdriver.com/).

For example, on a Linux host:
* `pipenv shell`
* `pip install .`
* `pumpkin-mcu-service -c ./test-config.toml`


In the tests folder, there is an integration test script that can be run to verify communication with all modules on the bus. It will retrieve what modules are present, request what fields are available for each module, and retrieve all available telemetry for each module.

Run with:

.. code:: 

  python integration_test.py -c /path/to/service/config.toml
